generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Asset {
  id        String   @id @default(cuid())
  name      String
  type      String
  riskLevel String   @default("low")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([type, riskLevel])
  @@index([deletedAt, createdAt])
}

// --- Scanner: rules, findings, controls ---

model ComplianceRule {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  description  String?
  resourceType String   // s3 | iam_user | security_group | rds | ebs | cloudtrail
  severity     String   // critical | high | medium | low | informational
  conditions   Json     // RuleCondition[]
  controlIds   String[] // e.g. ["CIS-1.1", "SOC2-CC6.1"]
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  findings Finding[]

  @@index([resourceType, enabled])
  @@index([code])
}

model Finding {
  id           String   @id @default(cuid())
  resourceId   String
  resourceType String
  ruleId       String
  ruleCode     String
  severity     String
  message      String
  status       String   @default("open") // open | acknowledged | resolved | suppressed
  controlIds   String[]
  rawResource  Json?    // snapshot of resource at finding time
  scanJobId    String?
  firstSeenAt  DateTime @default(now())
  lastSeenAt   DateTime @updatedAt
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  rule    ComplianceRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  scanJob ScanJob?       @relation(fields: [scanJobId], references: [id], onDelete: SetNull)

  @@unique([resourceId, ruleId])
  @@index([status, severity])
  @@index([ruleId])
  @@index([resourceId])
  @@index([scanJobId])
}

model Control {
  id        String   @id @default(cuid())
  controlId String   @unique // e.g. CIS-1.1
  framework String?  // CIS | SOC2 | custom
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([framework])
}

// --- Prowler scanner engine: checks, compliance frameworks, mappings ---

model ProwlerCheck {
  id          String   @id @default(cuid())
  provider    String   // aws | azure | gcp | kubernetes
  service     String
  checkName   String   @unique // e.g. iam_root_mfa_enabled
  severity    String   // critical | high | medium | low
  description String?  @db.Text
  risk        String?  @db.Text
  remediation String?  @db.Text
  metadata    Json?    // full metadata.json preserved
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([provider, service])
  @@index([provider, severity])
}

model ComplianceFramework {
  id        String   @id @default(cuid())
  provider  String
  name      String   // e.g. CIS Amazon Web Services Foundations Benchmark v1.5.0
  framework String   // e.g. CIS
  version   String?
  source    String?  // e.g. cis_1.5_aws.json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  complianceMappings ComplianceMapping[]

  @@unique([provider, source])
  @@index([provider])
}

model ComplianceMapping {
  id          String   @id @default(cuid())
  frameworkId String
  controlId   String   // e.g. 1.9, 1.10
  checkName   String   // maps to ProwlerCheck.checkName
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  framework ComplianceFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)

  @@unique([frameworkId, controlId, checkName])
  @@index([checkName])
  @@index([frameworkId])
}

// --- CloudSploit scanner engine ---

model CloudSploitRule {
  id          String   @id @default(cuid())
  provider    String   // aws | azure | gcp | oci
  service     String   // s3 | iam | ec2 | etc.
  ruleName    String   @unique // e.g. bucketAllUsersAcl
  severity    String   // critical | high | medium | low
  description String?  @db.Text
  compliance  Json?    // { hipaa: "...", pci: "...", cis1: "...", cis2: "..." }
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  scanResults CloudSploitScanResult[]

  @@index([provider, service])
  @@index([provider, severity])
}

model CloudSploitScan {
  id          String   @id @default(cuid())
  provider    String
  status      String   @default("pending") // pending | running | completed | failed
  startedAt   DateTime?
  completedAt DateTime?
  errorMessage String?
  resultCount Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  results CloudSploitScanResult[]

  @@index([status, createdAt])
}

model CloudSploitScanResult {
  id          String   @id @default(cuid())
  scanId      String
  ruleId      String
  ruleName    String   // plugin id for display when rule not yet synced
  status      String   // PASS | FAIL | INFO
  resourceId   String?
  region      String?
  message     String?  @db.Text
  raw         Json?
  timestamp   DateTime @default(now())

  scan CloudSploitScan @relation(fields: [scanId], references: [id], onDelete: Cascade)
  rule CloudSploitRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([scanId])
  @@index([ruleId])
}

// --- Scan orchestration ---

model ScanJob {
  id          String   @id @default(cuid())
  type        String   // full | incremental | on_demand
  status      String   @default("pending") // pending | running | completed | failed
  startedAt   DateTime?
  completedAt DateTime?
  errorMessage String?
  resourceCount Int    @default(0)
  findingCount Int    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  collectedResources CollectedResource[]
  findings          Finding[]

  @@index([status, createdAt])
}

model CollectedResource {
  id         String   @id @default(cuid())
  scanJobId  String
  resourceId String   // AWS resource identifier
  resourceType String // s3 | iam_user | security_group | rds | ebs | cloudtrail
  region     String
  accountId  String?
  metadata   Json     // normalized resource data
  fetchedAt  DateTime @default(now())

  scanJob ScanJob @relation(fields: [scanJobId], references: [id], onDelete: Cascade)

  @@unique([scanJobId, resourceId, resourceType])
  @@index([scanJobId])
  @@index([resourceType])
}

