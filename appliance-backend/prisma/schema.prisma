generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ComplianceControlState {
  PASSED
  FAILED
  NOT_EVALUATED
  NOT_APPLICABLE
}

enum CriteriaScopeStatus {
  IN_SCOPE
  OUT_OF_SCOPE
}

enum ControlReadinessStatus {
  READY
  PARTIAL
  NOT_READY
}

model Asset {
  id        String   @id @default(cuid())
  name      String
  type      String
  riskLevel String   @default("low")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([type, riskLevel])
  @@index([deletedAt, createdAt])
}

// --- Scanner: rules, findings, controls ---

model ComplianceRule {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  description  String?
  resourceType String   // s3 | iam_user | security_group | rds | ebs | cloudtrail
  severity     String   // critical | high | medium | low | informational
  conditions   Json     // RuleCondition[]
  controlIds   String[] // e.g. ["CIS-1.1", "SOC2-CC6.1"]
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  findings Finding[]

  @@index([resourceType, enabled])
  @@index([code])
}

model Finding {
  id           String   @id @default(cuid())
  resourceId   String
  resourceType String
  ruleId       String
  ruleCode     String
  severity     String
  message      String
  status       String   @default("open") // open | acknowledged | resolved | suppressed
  controlIds   String[]
  rawResource  Json?    // snapshot of resource at finding time
  scanJobId    String?
  firstSeenAt  DateTime @default(now())
  lastSeenAt   DateTime @updatedAt
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  rule    ComplianceRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  scanJob ScanJob?       @relation(fields: [scanJobId], references: [id], onDelete: SetNull)

  @@unique([resourceId, ruleId])
  @@index([status, severity])
  @@index([ruleId])
  @@index([resourceId])
  @@index([scanJobId])
}

model Control {
  id        String   @id @default(cuid())
  controlId String   @unique // e.g. CIS-1.1
  framework String?  // CIS | SOC2 | custom
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([framework])
}

// --- Prowler scanner engine: checks, compliance frameworks, mappings ---

model ProwlerCheck {
  id          String   @id @default(cuid())
  provider    String   // aws | azure | gcp | kubernetes
  service     String
  checkName   String   @unique // e.g. iam_root_mfa_enabled
  severity    String   // critical | high | medium | low
  description String?  @db.Text
  risk        String?  @db.Text
  remediation String?  @db.Text
  metadata    Json?    // full metadata.json preserved
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([provider, service])
  @@index([provider, severity])
}

model ComplianceFramework {
  id        String   @id @default(cuid())
  provider  String
  name      String   // e.g. CIS Amazon Web Services Foundations Benchmark v1.5.0
  framework String   // e.g. CIS
  version   String?
  source    String?  // e.g. cis_1.5_aws.json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  complianceMappings ComplianceMapping[]

  @@unique([provider, source])
  @@index([provider])
}

model ComplianceMapping {
  id          String   @id @default(cuid())
  frameworkId String
  controlId   String   // e.g. 1.9, 1.10
  checkName   String   // maps to ProwlerCheck.checkName
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  framework ComplianceFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)

  @@unique([frameworkId, controlId, checkName])
  @@index([checkName])
  @@index([frameworkId])
}

model ComplianceControlStatus {
  id              String                 @id @default(cuid())
  scanId          String                 @map("scan_id")
  framework       String
  controlId       String                 @map("control_id")
  checkId         String                 @map("check_id")
  status          ComplianceControlState
  isNotApplicable Boolean                @default(false) @map("is_not_applicable")
  createdAt       DateTime               @default(now()) @map("created_at")
  updatedAt       DateTime               @updatedAt @map("updated_at")

  @@unique([scanId, framework, controlId, checkId], map: "compliance_control_status_scan_framework_control_check_key")
  @@index([scanId], map: "compliance_control_status_scan_id_idx")
  @@index([framework], map: "compliance_control_status_framework_idx")
  @@index([checkId], map: "compliance_control_status_check_id_idx")
  @@map("compliance_control_status")
}

// --- CloudSploit scanner engine ---

model CloudSploitRule {
  id          String   @id @default(cuid())
  provider    String   // aws | azure | gcp | oci
  service     String   // s3 | iam | ec2 | etc.
  ruleName    String   @unique // e.g. bucketAllUsersAcl
  severity    String   // critical | high | medium | low
  description String?  @db.Text
  compliance  Json?    // { hipaa: "...", pci: "...", cis1: "...", cis2: "..." }
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  scanResults CloudSploitScanResult[]

  @@index([provider, service])
  @@index([provider, severity])
}

model CloudSploitScan {
  id          String   @id @default(cuid())
  provider    String
  status      String   @default("pending") // pending | running | completed | failed
  startedAt   DateTime?
  completedAt DateTime?
  errorMessage String?
  resultCount Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  results CloudSploitScanResult[]

  @@index([status, createdAt])
}

model CloudSploitScanResult {
  id          String   @id @default(cuid())
  scanId      String
  ruleId      String
  ruleName    String   // plugin id for display when rule not yet synced
  status      String   // PASS | FAIL | INFO
  resourceId   String?
  region      String?
  message     String?  @db.Text
  raw         Json?
  timestamp   DateTime @default(now())

  scan CloudSploitScan @relation(fields: [scanId], references: [id], onDelete: Cascade)
  rule CloudSploitRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([scanId])
  @@index([ruleId])
}

// --- Scan orchestration ---

model ScanJob {
  id          String   @id @default(cuid())
  type        String   // full | incremental | on_demand
  status      String   @default("pending") // pending | running | completed | failed
  startedAt   DateTime?
  completedAt DateTime?
  errorMessage String?
  resourceCount Int    @default(0)
  findingCount Int    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  collectedResources CollectedResource[]
  findings          Finding[]

  @@index([status, createdAt])
}

model CollectedResource {
  id         String   @id @default(cuid())
  scanJobId  String
  resourceId String   // AWS resource identifier
  resourceType String // s3 | iam_user | security_group | rds | ebs | cloudtrail
  region     String
  accountId  String?
  metadata   Json     // normalized resource data
  fetchedAt  DateTime @default(now())

  scanJob ScanJob @relation(fields: [scanJobId], references: [id], onDelete: Cascade)

  @@unique([scanJobId, resourceId, resourceType])
  @@index([scanJobId])
  @@index([resourceType])
}

// --- Enterprise compliance coverage domain ---

model FrameworkCatalog {
  id          String   @id @default(cuid())
  name        String
  version     String?
  category    String?
  region      String?
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  areas           FrameworkArea[]
  frameworkStatus FrameworkStatus[]

  @@index([name], map: "frameworks_name_idx")
  @@map("frameworks")
}

model FrameworkArea {
  id          String   @id @default(cuid())
  frameworkId String   @map("framework_id")
  name        String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  framework FrameworkCatalog  @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  criteria  FrameworkCriteria[]

  @@index([frameworkId], map: "framework_areas_framework_id_idx")
  @@map("framework_areas")
}

model FrameworkCriteria {
  id          String             @id @default(cuid())
  areaId      String             @map("area_id")
  code        String
  description String?
  scopeStatus CriteriaScopeStatus @default(IN_SCOPE) @map("scope_status")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  area            FrameworkArea            @relation(fields: [areaId], references: [id], onDelete: Cascade)
  controlMappings CriteriaControlMapping[]
  criteriaStatus  CriteriaStatus[]

  @@unique([areaId, code], map: "framework_criteria_area_code_key")
  @@index([scopeStatus], map: "framework_criteria_scope_status_idx")
  @@map("framework_criteria")
}

model GrcControl {
  id        String   @id @default(cuid())
  name      String
  domain    String?
  owner     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  criteriaMappings CriteriaControlMapping[]
  checkMappings    ControlCheckMapping[]
  controlStatus    ControlStatus[]

  @@index([name], map: "controls_name_idx")
  @@map("controls")
}

model CriteriaControlMapping {
  id         String   @id @default(cuid())
  criteriaId String   @map("criteria_id")
  controlId  String   @map("control_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  criteria FrameworkCriteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)
  control  GrcControl        @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([criteriaId, controlId], map: "criteria_control_mappings_criteria_control_key")
  @@index([criteriaId], map: "criteria_control_mappings_criteria_id_idx")
  @@index([controlId], map: "criteria_control_mappings_control_id_idx")
  @@map("criteria_control_mappings")
}

model ControlCheckMapping {
  id        String   @id @default(cuid())
  controlId String   @map("control_id")
  checkId   String   @map("check_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  control GrcControl @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([controlId, checkId], map: "control_check_mappings_control_check_key")
  @@index([controlId], map: "control_check_mappings_control_id_idx")
  @@index([checkId], map: "control_check_mappings_check_id_idx")
  @@map("control_check_mappings")
}

model ControlStatus {
  id               String                @id @default(cuid())
  controlId        String                @map("control_id")
  scanId           String                @map("scan_id")
  readinessPercent Int                   @map("readiness_percent")
  status           ControlReadinessStatus
  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")

  control GrcControl @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([controlId, scanId], map: "control_status_control_scan_key")
  @@index([scanId], map: "control_status_scan_id_idx")
  @@index([status], map: "control_status_status_idx")
  @@map("control_status")
}

model CriteriaStatus {
  id               String   @id @default(cuid())
  criteriaId       String   @map("criteria_id")
  scanId           String   @map("scan_id")
  readinessPercent Int      @map("readiness_percent")
  readyControls    Int      @map("ready_controls")
  totalControls    Int      @map("total_controls")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  criteria FrameworkCriteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)

  @@unique([criteriaId, scanId], map: "criteria_status_criteria_scan_key")
  @@index([scanId], map: "criteria_status_scan_id_idx")
  @@map("criteria_status")
}

model FrameworkStatus {
  id                        String   @id @default(cuid())
  frameworkId               String   @map("framework_id")
  scanId                    String   @map("scan_id")
  readinessPercent          Int      @map("framework_readiness_percent")
  readyCriteria             Int      @map("ready_criteria")
  totalCriteria             Int      @map("total_criteria")
  totalControls             Int      @map("total_controls")
  totalAutomatedChecks      Int      @map("total_automated_checks")
  inScopeCriteria           Int      @map("in_scope_criteria")
  outOfScopeCriteria        Int      @map("out_of_scope_criteria")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  framework FrameworkCatalog @relation(fields: [frameworkId], references: [id], onDelete: Cascade)

  @@unique([frameworkId, scanId], map: "framework_status_framework_scan_key")
  @@index([scanId], map: "framework_status_scan_id_idx")
  @@map("framework_status")
}

